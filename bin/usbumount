#!/bin/bash

# List mounted USB partitions. If first argument is not empty, include non-removables, else include only non-removables.
list_mounted() {
	# First get a list of USB devices.
	for disk in $(lsblk -oPATH,TRAN | awk '{if ($2 == "usb") {print $1}}'); do
		# For each disk, get a list of its mounted partitions.
		if test -n "$1"; then
			# Include non-removables.
			lsblk -oLABEL,PATH,SIZE,RM,MOUNTPOINT -n $disk | awk '{if (NF == 5) {print}}'
		else
			# Include only removables.
			lsblk -oLABEL,PATH,SIZE,RM,MOUNTPOINT -n $disk | awk '{if (NF == 5 && $4 == 1) {print}}'
		fi
	done
}

# This script must be run as root/sudo.
if [ $(id -u) -ne 0 ]; then
	echo ERROR: must run as root/sudo.
	exit 1
fi

# Support "lall" option, which include non-removable USB storages.
if [ $# -gt 0 ]; then
	if [ "$1" == "all" ]; then
		all=yes
	else
		echo Unknown option. Use \"all\" to include non-removable USB storage. 
		exit 1
	fi
fi

found=0
umount=0

while IFS= read -r -u 3 line; do
	let found+=1
	read -r label dev size rm dir <<< $line
	read -r -p "Found $label ($dev, $size) mounted at \"$dir\". Unmount (y/[n])? " response
	case $response in
		[yY])
			let umount+=1
			echo Unmounting $label ...
			umount $dev
			rm -fr "$dir"
			;;
		*)
			;;
	esac
done 3< <(list_mounted $all)

if ! (( $found )); then
	echo No mounted, removable USB partition found.
elif ! (( $umount )); then
	echo No USB partiton was un-mounted.
else
	echo $umount/$found USB partition was un-mounted.
fi

echo NOTE: Use \"all\" to include non-removable USB storage.
